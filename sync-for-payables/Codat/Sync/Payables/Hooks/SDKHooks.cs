//------------------------------------------------------------------------------
// <auto-generated>
// This code was generated by Speakeasy (https://speakeasy.com). DO NOT EDIT.
//
// Changes to this file may cause incorrect behavior and will be lost when
// the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
#nullable enable
namespace Codat.Sync.Payables.Hooks
{
    using Codat.Sync.Payables.Utils;
    using System;
    using System.Collections.Generic;
    using System.Net.Http;
    using System.Threading.Tasks;

    /// <summary>
    /// Exception that can be thrown in <see cref="IAfterErrorHook"/> implementations to prevent subsequent hooks from executing.
    /// </summary>
    public sealed class FailEarlyException : Exception {}

    /// <summary>
    /// Manages and executes SDK hooks at various stages of the request lifecycle.
    /// </summary>
    public class SDKHooks: IHooks
    {
        public List<ISDKInitHook> sdkInitHooks;
        public List<IBeforeRequestHook> beforeRequestHooks;
        public List<IAfterSuccessHook> afterSuccessHooks;
        public List<IAfterErrorHook> afterErrorHooks;

        public SDKHooks()
        {
            this.sdkInitHooks = new List<ISDKInitHook>();
            this.beforeRequestHooks = new List<IBeforeRequestHook>();
            this.afterSuccessHooks = new List<IAfterSuccessHook>();
            this.afterErrorHooks = new List<IAfterErrorHook>();
            HookRegistration.InitHooks(this);
        }

        /// <summary>
        /// Registers an SDK initialization hook to be executed when the SDK is initialized.
        /// </summary>
        /// <param name="hook">The hook to register.</param>
        public void RegisterSDKInitHook(ISDKInitHook hook)
        {
            this.sdkInitHooks.Add(hook);
        }

        /// <summary>
        /// Registers a before request hook to be executed before each HTTP request.
        /// </summary>
        /// <param name="hook">The hook to register.</param>
        public void RegisterBeforeRequestHook(IBeforeRequestHook hook)
        {
            this.beforeRequestHooks.Add(hook);
        }

        /// <summary>
        /// Registers an after success hook to be executed after successful HTTP responses.
        /// </summary>
        /// <param name="hook">The hook to register.</param>
        public void RegisterAfterSuccessHook(IAfterSuccessHook hook)
        {
            this.afterSuccessHooks.Add(hook);
        }

        /// <summary>
        /// Registers an after error hook to be executed after errors or non-successful responses.
        /// </summary>
        /// <param name="hook">The hook to register.</param>
        public void RegisterAfterErrorHook(IAfterErrorHook hook)
        {
            this.afterErrorHooks.Add(hook);
        }
        
        /// <summary>
        /// Executes all registered SDK initialization hooks.
        /// </summary>
        /// <param name="baseUrl">The base URL for the SDK.</param>
        /// <param name="client">The HTTP client.</param>
        /// <returns>The potentially modified base URL and HTTP client.</returns>
        public (string, ISpeakeasyHttpClient) SDKInit(string baseUrl, ISpeakeasyHttpClient client)
        {
            var urlAndClient = (baseUrl, client);
            foreach (var hook in this.sdkInitHooks)
            {
                try
                {
                    urlAndClient = hook.SDKInit(urlAndClient.Item1, urlAndClient.Item2);
                } catch (Exception ex)
                {
                    throw new Exception("An error occurred while calling SDKInit hook.", ex);
                }
            }
            return urlAndClient;
        }
        
        /// <summary>
        /// Executes all registered before request hooks.
        /// </summary>
        /// <param name="hookCtx">The hook context containing request metadata.</param>
        /// <param name="request">The HTTP request message.</param>
        /// <returns>The potentially modified HTTP request message.</returns>
        public async Task<HttpRequestMessage> BeforeRequestAsync(BeforeRequestContext hookCtx, HttpRequestMessage request)
        {
            foreach (var hook in this.beforeRequestHooks)
            {
                try
                {
                    request = await hook.BeforeRequestAsync(hookCtx, request);
                }
                catch (Exception ex)
                {
                    throw new Exception("An error occurred while calling BeforeRequestAsync hook", ex);
                }
            }
            return request;
        }

        /// <summary>
        /// Executes all registered after success hooks.
        /// </summary>
        /// <param name="hookCtx">The hook context containing request metadata.</param>
        /// <param name="response">The HTTP response message.</param>
        /// <returns>The potentially modified HTTP response message.</returns>
        public async Task<HttpResponseMessage> AfterSuccessAsync(AfterSuccessContext hookCtx, HttpResponseMessage response)
        {
            foreach (var hook in this.afterSuccessHooks)
            {
                try
                {
                    response = await hook.AfterSuccessAsync(hookCtx, response);
                }
                catch (Exception ex)
                {
                    throw new Exception("An error occurred while calling AfterSuccessAsync hook.", ex);
                }
            }
            return response;
        }

        /// <summary>
        /// Executes all registered after error hooks.
        /// </summary>
        /// <param name="hookCtx">The hook context containing request metadata.</param>
        /// <param name="response">The HTTP response message, if available.</param>
        /// <param name="error">The exception that occurred, if any.</param>
        /// <returns>The potentially modified HTTP response message.</returns>
        /// <exception cref="FailEarlyException">Thrown by a hook to prevent subsequent error hooks from executing.</exception>
        public async Task<HttpResponseMessage?> AfterErrorAsync(AfterErrorContext hookCtx, HttpResponseMessage? response, Exception? error)
        {
            (HttpResponseMessage?, Exception?) responseAndError = (response, error);
            foreach (var hook in this.afterErrorHooks)
            {
                try
                {
                    responseAndError = await hook.AfterErrorAsync(hookCtx, responseAndError.Item1, responseAndError.Item2);
                }
                catch (FailEarlyException)
                {
                    throw;
                }
                catch (Exception ex)
                {
                    throw new Exception("An error occurred while calling AfterErrorAsync hook", ex);
                }
            }

            if (responseAndError.Item2 != null)
            {
                throw responseAndError.Item2;
            }

            return responseAndError.Item1;
        }
    }
}